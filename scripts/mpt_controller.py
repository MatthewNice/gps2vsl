#!/usr/bin/env python

import rospy
from std_msgs.msg import Float64, Int16, String, Bool
from geometry_msgs.msg import PointStamped
from sensor_msgs.msg import NavSatFix, TimeReference
import traceback
import os
import sys
import time
import requests
import time
import bisect
import numpy as np
import pandas as pd
# import shapely
# from shapely import LineString,Point
# from shapely.ops import nearest_points
# from shapely import Polygon
import json
# from mpc_accel import mpc_accel

import numpy as np
from scipy.optimize import linprog

def mpc_accel(x):

  Hx = np.array([[-0.04987547,  0.04987547,  0.99750934],
       [-0.07442084,  0.09922779,  0.99227788],
       [-0.1467348 ,  0.1467348 ,  0.97823198],
       [-0.1691295 ,  0.19329085,  0.96645427],
       [-0.23570226,  0.23570226,  0.94280904],
       [-0.25471426,  0.27787011,  0.92623369],
       [-0.3136775 ,  0.3136775 ,  0.89622143],
       [-0.32881772,  0.35073891,  0.87684726],
       [-0.37964209,  0.37964209,  0.84364908],
       [-0.39102597,  0.41160629,  0.82321258],
       [-0.43413537,  0.43413537,  0.78933704],
       [-0.44222593,  0.46145314,  0.76908857],
       [-0.47853661,  0.47853661,  0.73621017],
       [-0.4839207 ,  0.50184369,  0.71691956],
       [-0.51449576,  0.51449576,  0.68599434],
       [-0.51774643,  0.53444793,  0.66805991],
       [-0.54360006,  0.54360006,  0.63952948],
       [-0.54521367,  0.5607912 ,  0.62310134],
       [-0.56722736,  0.56722736,  0.59708143],
       [-0.56760682,  0.58216084,  0.58216084],
       [-0.58650981,  0.58650981,  0.55858077],
       [-0.5859703 ,  0.59959751,  0.54508865],
       [-0.60235022,  0.60235022,  0.5237828 ],
       [-0.60113312,  0.61392319,  0.51160266],
       [-0.61545745,  0.61545745,  0.49236596],
       [-0.61374552,  0.62577975,  0.48136903],
       [-0.62638437,  0.62638437,  0.46398842],
       [-0.62431511,  0.6356663 ,  0.45404735],
       [-0.63556158,  0.63556158,  0.43831833],
       [-0.63323824,  0.64397109,  0.42931406],
       [-0.64332523,  0.64332523,  0.41504854],
       [-0.64082526,  0.65099709,  0.40687318],
       [-0.64993883,  0.64993883,  0.39390232],
       [-0.64732034,  0.65698183,  0.3864599 ],
       [-0.65561007,  0.65561007,  0.37463432],
       [-0.6529167 ,  0.66211271,  0.36784039],
       [-0.6605037 ,  0.6605037 ,  0.35702903],
       [-0.65776822,  0.66653846,  0.35080972],
       [-0.66475127,  0.66475127,  0.34089809],
       [-0.66199826,  0.67037799,  0.33518899],
       [-0.66845852,  0.66845852,  0.32607733],
       [-0.6657064 ,  0.67372695,  0.32082236],
       [-0.67171103,  0.67171103,  0.31242373],
       [-0.66897352,  0.67666287,  0.30757403],
       [-0.67457852,  0.67457852,  0.29981268],
       [-0.6718658 ,  0.67924894,  0.29532563],
       [-0.67443768,  0.68153703,  0.28397376],
       [-0.6793771 ,  0.6793771 ,  0.27729678],
       [-0.67673426,  0.68356996,  0.27342798],
       [-0.68041382,  0.68041382,  0.27216553],
       [-0.67561788,  0.68258301,  0.27860531],
       [-0.6782801 ,  0.6782801 ,  0.28261671],
       [-0.67318878,  0.68042736,  0.28954356],
       [-0.67588616,  0.67588616,  0.29386355],
       [-0.67046287,  0.67799616,  0.30133163],
       [-0.67318907,  0.67318907,  0.30599503],
       [-0.66739064,  0.6752423 ,  0.31406619],
       [-0.67013693,  0.67013693,  0.31911282],
       [-0.66391212,  0.67210857,  0.32785784],
       [-0.66666667,  0.66666667,  0.33333333],
       [-0.65995421,  0.66852504,  0.34283336],
       [-0.6627011 ,  0.6627011 ,  0.34879005],
       [-0.65542722,  0.66440568,  0.3591382 ],
       [-0.65814518,  0.65814518,  0.36563621],
       [-0.65022043,  0.65964392,  0.37693938],
       [-0.65288107,  0.65288107,  0.38404769],
       [-0.64419617,  0.65410688,  0.39642841],
       [-0.64676167,  0.64676167,  0.40422604],
       [-0.63718215,  0.64762776,  0.41782436],
       [-0.63960215,  0.63960215,  0.42640143],
       [-0.62896133,  0.63999574,  0.44137637],
       [-0.63116874,  0.63116874,  0.45083482],
       [-0.61925861,  0.63094274,  0.46736499],
       [-0.62116403,  0.62116403,  0.47781848],
       [-0.60772345,  0.62012597,  0.49610078],
       [-0.6092077 ,  0.6092077 ,  0.50767308],
       [-0.59390741,  0.60710535,  0.52791769],
       [-0.59481188,  0.59481188,  0.54073807],
       [-0.57723582,  0.59131474,  0.5631569 ],
       [-0.57735027,  0.57735027,  0.57735027],
       [-0.55697379,  0.57202714,  0.60213383],
       [-0.55602186,  0.55602186,  0.61780206],
       [-0.53218885,  0.54831578,  0.64507739],
       [-0.52981294,  0.52981294,  0.66226618],
       [-0.50171809,  0.51901871,  0.69202495],
       [-0.49746834,  0.49746834,  0.71066905],
       [-0.46415833,  0.48272466,  0.74265332],
       [-0.45749571,  0.45749571,  0.76249285],
       [-0.41791562,  0.43781636,  0.79602975],
       [-0.40824829,  0.40824829,  0.81649658],
       [-0.36137509,  0.38263245,  0.85029433],
       [-0.34815531,  0.34815531,  0.87038828],
       [-0.29326624,  0.31582518,  0.90235767],
       [-0.27617239,  0.27617239,  0.92057462],
       [-0.21326056,  0.23695618,  0.94782472],
       [-0.19245009,  0.19245009,  0.96225045],
       [-0.12268323,  0.14721987,  0.98146581],
       [-0.09901475,  0.09901475,  0.99014754],
       [ 0.04987547, -0.04987547, -0.99750934],
       [ 0.02496103, -0.04992206, -0.99844115],
       [-0.02496103,  0.04992206,  0.99844115],
       [ 0.1467348 , -0.1467348 , -0.97823198],
       [ 0.12268323, -0.14721987, -0.98146581],
       [ 0.23570226, -0.23570226, -0.94280904],
       [ 0.21326056, -0.23695618, -0.94782472],
       [ 0.3136775 , -0.3136775 , -0.89622143],
       [ 0.29326624, -0.31582518, -0.90235767],
       [ 0.37964209, -0.37964209, -0.84364908],
       [ 0.36137509, -0.38263245, -0.85029433],
       [ 0.43413537, -0.43413537, -0.78933704],
       [ 0.41791562, -0.43781636, -0.79602975],
       [ 0.47853661, -0.47853661, -0.73621017],
       [ 0.46415833, -0.48272466, -0.74265332],
       [ 0.51449576, -0.51449576, -0.68599434],
       [ 0.50171809, -0.51901871, -0.69202495],
       [ 0.54360006, -0.54360006, -0.63952948],
       [ 0.53218885, -0.54831578, -0.64507739],
       [ 0.56722736, -0.56722736, -0.59708143],
       [ 0.55697379, -0.57202714, -0.60213383],
       [ 0.58650981, -0.58650981, -0.55858077],
       [ 0.57723582, -0.59131474, -0.5631569 ],
       [ 0.60235022, -0.60235022, -0.5237828 ],
       [ 0.59390741, -0.60710535, -0.52791769],
       [ 0.61545745, -0.61545745, -0.49236596],
       [ 0.60772345, -0.62012597, -0.49610078],
       [ 0.62638437, -0.62638437, -0.46398842],
       [ 0.61925861, -0.63094274, -0.46736499],
       [ 0.63556158, -0.63556158, -0.43831833],
       [ 0.62896133, -0.63999574, -0.44137637],
       [ 0.64332523, -0.64332523, -0.41504854],
       [ 0.63718215, -0.64762776, -0.41782436],
       [ 0.64993883, -0.64993883, -0.39390232],
       [ 0.64419617, -0.65410688, -0.39642841],
       [ 0.65561007, -0.65561007, -0.37463432],
       [ 0.65022043, -0.65964392, -0.37693938],
       [ 0.6605037 , -0.6605037 , -0.35702903],
       [ 0.65542722, -0.66440568, -0.3591382 ],
       [ 0.66475127, -0.66475127, -0.34089809],
       [ 0.65995421, -0.66852504, -0.34283336],
       [ 0.66845852, -0.66845852, -0.32607733],
       [ 0.66391212, -0.67210857, -0.32785784],
       [ 0.67171103, -0.67171103, -0.31242373],
       [ 0.66739064, -0.6752423 , -0.31406619],
       [ 0.67457852, -0.67457852, -0.29981268],
       [ 0.67046287, -0.67799616, -0.30133163],
       [ 0.67711816, -0.67711816, -0.28813539],
       [ 0.67318878, -0.68042736, -0.28954356],
       [ 0.6793771 , -0.6793771 , -0.27729678],
       [ 0.67561788, -0.68258301, -0.27860531],
       [ 0.67673426, -0.68356996, -0.27342798],
       [ 0.68041382, -0.68041382, -0.27216553],
       [ 0.67443768, -0.68153703, -0.28397376],
       [ 0.6782801 , -0.6782801 , -0.28261671],
       [ 0.6718658 , -0.67924894, -0.29532563],
       [ 0.67588616, -0.67588616, -0.29386355],
       [ 0.66897352, -0.67666287, -0.30757403],
       [ 0.67318907, -0.67318907, -0.30599503],
       [ 0.6657064 , -0.67372695, -0.32082236],
       [ 0.67013693, -0.67013693, -0.31911282],
       [ 0.66199826, -0.67037799, -0.33518899],
       [ 0.66666667, -0.66666667, -0.33333333],
       [ 0.65776822, -0.66653846, -0.35080972],
       [ 0.6627011 , -0.6627011 , -0.34879005],
       [ 0.6529167 , -0.66211271, -0.36784039],
       [ 0.65814518, -0.65814518, -0.36563621],
       [ 0.64732034, -0.65698183, -0.3864599 ],
       [ 0.65288107, -0.65288107, -0.38404769],
       [ 0.64082526, -0.65099709, -0.40687318],
       [ 0.64676167, -0.64676167, -0.40422604],
       [ 0.63323824, -0.64397109, -0.42931406],
       [ 0.63960215, -0.63960215, -0.42640143],
       [ 0.62431511, -0.6356663 , -0.45404735],
       [ 0.63116874, -0.63116874, -0.45083482],
       [ 0.61374552, -0.62577975, -0.48136903],
       [ 0.62116403, -0.62116403, -0.47781848],
       [ 0.60113312, -0.61392319, -0.51160266],
       [ 0.6092077 , -0.6092077 , -0.50767308],
       [ 0.5859703 , -0.59959751, -0.54508865],
       [ 0.59481188, -0.59481188, -0.54073807],
       [ 0.56760682, -0.58216084, -0.58216084],
       [ 0.57735027, -0.57735027, -0.57735027],
       [ 0.54521367, -0.5607912 , -0.62310134],
       [ 0.55602186, -0.55602186, -0.61780206],
       [ 0.51774643, -0.53444793, -0.66805991],
       [ 0.52981294, -0.52981294, -0.66226618],
       [ 0.4839207 , -0.50184369, -0.71691956],
       [ 0.49746834, -0.49746834, -0.71066905],
       [ 0.44222593, -0.46145314, -0.76908857],
       [ 0.45749571, -0.45749571, -0.76249285],
       [ 0.39102597, -0.41160629, -0.82321258],
       [ 0.40824829, -0.40824829, -0.81649658],
       [ 0.32881772, -0.35073891, -0.87684726],
       [ 0.34815531, -0.34815531, -0.87038828],
       [ 0.25471426, -0.27787011, -0.92623369],
       [ 0.27617239, -0.27617239, -0.92057462],
       [ 0.1691295 , -0.19329085, -0.96645427],
       [ 0.19245009, -0.19245009, -0.96225045],
       [ 0.07442084, -0.09922779, -0.99227788],
       [ 0.09901475, -0.09901475, -0.99014754],
       [ 0.        ,  1.        ,  0.        ],
       [ 0.        , -1.        ,  0.        ],
       [ 1.        ,  0.        ,  0.        ],
       [-1.        ,  0.        ,  0.        ],
       [ 0.        ,  0.        ,  1.        ],
       [ 0.        ,  0.        , -1.        ],
       [ 0.89855258, -0.02191592, -0.43831833],
       [ 0.90491229, -0.06313342, -0.42088944],
       [ 0.90913729, -0.10101525, -0.40406102],
       [ 0.9116337 , -0.13577523, -0.38792923],
       [ 0.91274422, -0.1676469 , -0.37254866],
       [ 0.91275396, -0.1968685 , -0.35794273],
       [ 0.91189755, -0.22367298, -0.34411228],
       [ 0.91036648, -0.24828177, -0.33104236],
       [ 0.90831607, -0.27090129, -0.31870739],
       [ 0.90587167, -0.29172139, -0.30707514],
       [ 0.903134  , -0.31091499, -0.29610951],
       [ 0.90018373, -0.3286385 , -0.28577261],
       [ 0.89708523, -0.34503278, -0.27602622],
       [ 0.8938897 , -0.36022421, -0.26683275],
       [ 0.89063774, -0.37432601, -0.25815587],
       [ 0.88736136, -0.38743947, -0.24996095],
       [ 0.88408569, -0.39965518, -0.24221526],
       [ 0.88083033, -0.41105415, -0.23488809],
       [ 0.87761042, -0.4217089 , -0.22795076],
       [ 0.87443754, -0.43168436, -0.22137659],
       [ 0.87132041, -0.44103873, -0.21514084],
       [ 0.86826544, -0.44982426, -0.20922059],
       [ 0.86527722, -0.45808794, -0.20359464],
       [ 0.86235886, -0.46587203, -0.19824342],
       [ 0.85951232, -0.47321465, -0.19314884],
       [ 0.85811633, -0.47673129, -0.19069252],
       [ 0.86092653, -0.46959629, -0.19566512],
       [ 0.86380916, -0.46203746, -0.20088585],
       [ 0.86676276, -0.45401859, -0.20637209],
       [ 0.86978483, -0.44549955, -0.21214264],
       [ 0.87287156, -0.43643578, -0.21821789],
       [ 0.8760175 , -0.42677776, -0.22461987],
       [ 0.87921515, -0.41647033, -0.23137241],
       [ 0.88245443, -0.40545204, -0.2385012 ],
       [ 0.8857221 , -0.39365427, -0.24603392],
       [ 0.88900089, -0.38100038, -0.25400025],
       [ 0.8922686 , -0.36740472, -0.26243194],
       [ 0.89549683, -0.35277148, -0.27136268],
       [ 0.89864953, -0.33699357, -0.28082798],
       [ 0.90168108, -0.31995135, -0.29086486],
       [ 0.90453403, -0.30151134, -0.30151134],
       [ 0.90713631, -0.28152506, -0.31280562],
       [ 0.90939772, -0.25982792, -0.3247849 ],
       [ 0.91120586, -0.23623856, -0.33748365],
       [ 0.91242113, -0.21055872, -0.3509312 ],
       [ 0.91287093, -0.18257419, -0.36514837],
       [ 0.91234311, -0.15205718, -0.38014296],
       [ 0.91057872, -0.11877114, -0.39590379],
       [ 0.90726471, -0.08247861, -0.41239305],
       [ 0.90202724, -0.04295368, -0.42953678],
       [ 2.        ,  0.        , -1.        ]])

  hx = np.array([[ 2.99254671e+02],
       [ 2.98431292e+02],
       [ 2.93486100e+02],
       [ 2.90682867e+02],
       [ 2.82886907e+02],
       [ 2.78616883e+02],
       [ 2.68948769e+02],
       [ 2.63803884e+02],
       [ 2.53222854e+02],
       [ 2.47720100e+02],
       [ 2.36980192e+02],
       [ 2.31493737e+02],
       [ 2.21096339e+02],
       [ 2.15858207e+02],
       [ 2.06087706e+02],
       [ 2.01219645e+02],
       [ 1.92205389e+02],
       [ 1.87755232e+02],
       [ 1.79528580e+02],
       [ 1.75499663e+02],
       [ 1.68036109e+02],
       [ 1.64407594e+02],
       [ 1.57654367e+02],
       [ 1.54394009e+02],
       [ 1.48286781e+02],
       [ 1.45358406e+02],
       [ 1.39830740e+02],
       [ 1.37198354e+02],
       [ 1.32186672e+02],
       [ 1.29816523e+02],
       [ 1.25262427e+02],
       [ 1.23123893e+02],
       [ 1.18974995e+02],
       [ 1.17040830e+02],
       [ 1.13250786e+02],
       [ 1.11497021e+02],
       [ 1.08025157e+02],
       [ 1.06430844e+02],
       [ 1.03241624e+02],
       [ 1.01788517e+02],
       [ 9.88509526e+01],
       [ 9.75231797e+01],
       [ 9.48102542e+01],
       [ 9.35940092e+01],
       [ 9.10821539e+01],
       [ 8.99654146e+01],
       [ 8.66063175e+01],
       [ 8.44373885e+01],
       [ 8.34895255e+01],
       [ 8.29254340e+01],
       [ 8.50191964e+01],
       [ 8.60059170e+01],
       [ 8.82539627e+01],
       [ 8.93249685e+01],
       [ 9.17441803e+01],
       [ 9.29092712e+01],
       [ 9.55189118e+01],
       [ 9.67893126e+01],
       [ 9.96114079e+01],
       [ 1.01000000e+02],
       [ 1.04059780e+02],
       [ 1.05581365e+02],
       [ 1.08907763e+02],
       [ 1.10579360e+02],
       [ 1.14205565e+02],
       [ 1.16046729e+02],
       [ 1.20010773e+02],
       [ 1.22043927e+02],
       [ 1.26389258e+02],
       [ 1.28639982e+02],
       [ 1.33415939e+02],
       [ 1.35913172e+02],
       [ 1.41175190e+02],
       [ 1.43951180e+02],
       [ 1.49760422e+02],
       [ 1.52850212e+02],
       [ 1.59272108e+02],
       [ 1.62712141e+02],
       [ 1.69812922e+02],
       [ 1.73638093e+02],
       [ 1.81477867e+02],
       [ 1.85715934e+02],
       [ 1.94336014e+02],
       [ 1.98997741e+02],
       [ 2.08398989e+02],
       [ 2.13461887e+02],
       [ 2.23570212e+02],
       [ 2.28953729e+02],
       [ 2.39570129e+02],
       [ 2.45102067e+02],
       [ 2.55840810e+02],
       [ 2.61220931e+02],
       [ 2.71455130e+02],
       [ 2.76234524e+02],
       [ 2.85093828e+02],
       [ 2.88704002e+02],
       [ 2.95186884e+02],
       [ 2.97051689e+02],
       [-1.49564056e+01],
       [-1.49766173e+01],
       [ 3.00281177e+02],
       [-1.46184541e+01],
       [-1.46851822e+01],
       [-1.39948217e+01],
       [-1.40988927e+01],
       [-1.31688536e+01],
       [-1.32984962e+01],
       [-1.22276389e+01],
       [-1.23717825e+01],
       [-1.12431194e+01],
       [-1.13931758e+01],
       [-1.02655306e+01],
       [-1.04157128e+01],
       [-9.32523557e+00],
       [-9.47209152e+00],
       [-8.43779207e+00],
       [-8.57952927e+00],
       [-7.60905652e+00],
       [-7.74494638e+00],
       [-6.83912335e+00],
       [-6.96906658e+00],
       [-6.12498513e+00],
       [-6.24922570e+00],
       [-5.46218491e+00],
       [-5.58113376e+00],
       [-4.84577905e+00],
       [-4.95991096e+00],
       [-4.27086423e+00],
       [-4.38066049e+00],
       [-3.73284278e+00],
       [-3.83876131e+00],
       [-3.22753714e+00],
       [-3.32999866e+00],
       [-2.75122082e+00],
       [-2.85060406e+00],
       [-2.30060579e+00],
       [-2.39724751e+00],
       [-1.87280886e+00],
       [-1.96700638e+00],
       [-1.46530998e+00],
       [-1.55732473e+00],
       [-1.07590923e+00],
       [-1.16597071e+00],
       [-7.02685958e-01],
       [-7.90995519e-01],
       [-3.43961617e-01],
       [-4.30696045e-01],
       [ 1.73310486e-03],
       [-8.35815930e-02],
       [ 8.54462445e-02],
       [ 1.70103454e-01],
       [-2.55576385e-01],
       [-1.69570026e-01],
       [-6.09109104e-01],
       [-5.21607801e-01],
       [-9.76547554e-01],
       [-8.87385589e-01],
       [-1.35948475e+00],
       [-1.26847347e+00],
       [-1.75974221e+00],
       [-1.66666667e+00],
       [-2.17940536e+00],
       [-2.08402057e+00],
       [-2.62086279e+00],
       [-2.52288986e+00],
       [-3.08684846e+00],
       [-2.98597076e+00],
       [-3.58048397e+00],
       [-3.47634396e+00],
       [-4.10531571e+00],
       [-3.99751343e+00],
       [-4.66533657e+00],
       [-4.55343166e+00],
       [-5.26497382e+00],
       [-5.14849415e+00],
       [-5.90901072e+00],
       [-5.78747314e+00],
       [-6.60238625e+00],
       [-6.47533839e+00],
       [-7.34978065e+00],
       [-7.21687836e+00],
       [-8.15483877e+00],
       [-8.01598177e+00],
       [-9.01880880e+00],
       [-8.87436679e+00],
       [-9.93829743e+00],
       [-9.78946623e+00],
       [-1.09018305e+01],
       [-1.07511492e+01],
       [-1.18851316e+01],
       [-1.17371384e+01],
       [-1.28458124e+01],
       [-1.27076689e+01],
       [-1.37198365e+01],
       [-1.36014900e+01],
       [-1.44243300e+01],
       [-1.43375317e+01],
       [-1.48717647e+01],
       [-1.48274595e+01],
       [ 3.00000000e+01],
       [ 0.00000000e+00],
       [ 3.00000000e+01],
       [ 0.00000000e+00],
       [ 3.00000000e+02],
       [-1.50000000e+01],
       [ 2.21898655e-01],
       [ 6.55009187e-01],
       [ 1.07328708e+00],
       [ 1.47655564e+00],
       [ 1.86507174e+00],
       [ 2.23937921e+00],
       [ 2.60019843e+00],
       [ 2.94834598e+00],
       [ 3.28467808e+00],
       [ 3.61005216e+00],
       [ 3.92530169e+00],
       [ 4.23122075e+00],
       [ 4.52855523e+00],
       [ 4.81799880e+00],
       [ 5.10019185e+00],
       [ 5.37572261e+00],
       [ 5.64512935e+00],
       [ 5.90890346e+00],
       [ 6.16749272e+00],
       [ 6.42130482e+00],
       [ 6.67071074e+00],
       [ 6.91604807e+00],
       [ 7.15762404e+00],
       [ 7.39571844e+00],
       [ 7.63058618e+00],
       [ 7.74688354e+00],
       [ 7.51354061e+00],
       [ 7.27708995e+00],
       [ 7.03728813e+00],
       [ 6.79386810e+00],
       [ 6.54653671e+00],
       [ 6.29497191e+00],
       [ 6.03881981e+00],
       [ 5.77769152e+00],
       [ 5.51115971e+00],
       [ 5.23875524e+00],
       [ 4.95996368e+00],
       [ 4.67422211e+00],
       [ 4.38091646e+00],
       [ 4.07937971e+00],
       [ 3.76889181e+00],
       [ 3.44868200e+00],
       [ 3.11793505e+00],
       [ 2.77580305e+00],
       [ 2.42142530e+00],
       [ 2.05395959e+00],
       [ 1.67262903e+00],
       [ 1.27678973e+00],
       [ 8.66025404e-01],
       [ 4.40275199e-01],
       [ 0.00000000e+00]])



  Hu = np.array([[1.0],[-1.0]])

  hu = np.array([[1.5],[5.0]])

  A = np.array([[1.0,0.0,0.0],
    [0.0,1.0,0.0],
    [-0.05,0.05,1]])

  B = np.array([[0.05],[0],[-0.00125]])

  LA = np.concatenate((np.matmul(Hx,B),Hu))
  Lb = np.matmul(np.matmul(Hx,A),x)
  Lb = hx - Lb
  Lb = np.concatenate((Lb,hu))
  # Lb = [hx-Hx*A*x0;hu]

  res = linprog(-1, A_ub=LA, b_ub=Lb,bounds=(-5.0,1.5))

  u = res.x[0]

  if(not res.success):
    # print('No solution found.')
    u = -5.0

  return u




velocity_topic = "/car/state/vel_x"
lead_x_topic = "/lead_dist"
lead_rv_topic = "/rel_vel"
cmd_accel_pre_topic = "/cmd_accel_pre"

cmd_accel_pre= None
velocity = None
lead_x=252
lead_rv=0

def velocity_callback(data):
    global velocity
    velocity = data.data

def lead_x_callback(data):
    global lead_x
    lead_x = data.data

def lead_rv_callback(data):
    global lead_rv
    lead_rv = data.data

def cmd_accel_pre_callback(data):
    global cmd_accel_pre
    cmd_accel_pre = data.data

class mpt:
    def __init__(self):
        rospy.init_node('mpt', anonymous=True)

        # rospy.Subscriber(gantry_topic,Int16,gantry_callback)
        rospy.Subscriber(velocity_topic,Float64,velocity_callback)
        rospy.Subscriber(cmd_accel_pre_topic,Float64,cmd_accel_pre_callback)

        rospy.Subscriber(lead_x_topic, Float64, lead_x_callback)
        rospy.Subscriber(lead_rv_topic, Float64, lead_rv_callback)


        global mpt_pub
        mpt_pub = rospy.Publisher('/cmd_accel', Float64, queue_size=1000)

        self.rate = rospy.Rate(20)

    def loop(self):
        while not rospy.is_shutdown():
            try:
                global mpt_pub
                global cmd_accel_pre
                global velocity
                global lead_rv
                global lead_x

                state=np.array([[velocity],[velocity+lead_rv],[lead_x]]).reshape((3,1))
                mpt_accel_max = mpc_accel(state)

                mpt_value = min(cmd_accel_pre,mpt_accel_max)

                mpt_pub.publish(mpt_value)

            except Exception as e:
                print(e)
                traceback.print_exc()
                print("Something has gone wrong.")
            self.rate.sleep()

if __name__ == '__main__':
    try:
        head = mpt()
        head.loop()
    except Exception as e:
        print(e)
        traceback.print_exc()
        print("An exception occurred")
